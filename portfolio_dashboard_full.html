<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Performance Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f6fa;
      color: #222;
    }
    header {
      background: #111827;
      color: white;
      padding: 16px 32px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 12px;
      opacity: 0.75;
    }
    .tabs {
      display: flex;
      gap: 8px;
      padding: 10px 32px 4px;
      background: #0f172a;
      box-shadow: 0 1px 4px rgba(15,23,42,0.45);
      position: sticky;
      top: 56px;
      z-index: 15;
    }
    .tab-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
      transition: background 0.15s, transform 0.1s;
    }
    .tab-btn.active {
      background: #2563eb;
      color: white;
      transform: translateY(-1px);
    }
    .container {
      padding: 20px 32px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .section {
      background: white;
      border-radius: 10px;
      padding: 20px 22px 26px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(15,23,42,0.08);
    }
    .section h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 4px;
    }
    .section p.desc {
      margin-top: 0;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .chart {
      width: 100%;
      height: 420px;
    }
    .small {
      height: 360px;
    }
    .footer-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 10px;
      margin-right: 6px;
    }
    .pill span {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 4px;
    }
    .pill .equity {
      background: #2563eb;
    }
    .pill .total {
      background: #db2777;
    }
    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <h1>Portfolio Performance Dashboard</h1>
    <p>USD Performance, Alpha/Beta, Sector P&amp;L, NAV by Country &amp; Sector</p>
  </header>

  <!-- 탭 네비게이션 -->
  <nav class="tabs">
    <button class="tab-btn active" data-tab="tab-performance">Performance</button>
    <button class="tab-btn" data-tab="tab-alpha-beta">Alpha / Beta</button>
    <button class="tab-btn" data-tab="tab-sector-pnl">Sector P&amp;L</button>
    <button class="tab-btn" data-tab="tab-nav">NAV View</button>
  </nav>

  <div class="container">
    <!-- TAB 1: Performance -->
    <section class="section tab-pane active" id="tab-performance">
      <h2>1. Equity vs Equity + Hedge (USD 누적 수익률)</h2>
      <p class="desc">
        <span class="pill"><span class="equity"></span>Equity Only</span>
        <span class="pill"><span class="total"></span>Equity + Hedge</span><br />
        <span style="font-size: 11px; color:#6b7280;">
          Data: <code>portfolio_daily_USD_with_hedge.csv</code> (Equity_Cum_Return, Total_Cum_Return)
        </span>
      </p>
      <div id="equityHedgeChart" class="chart"></div>
    </section>

    <!-- TAB 2: Alpha/Beta -->
    <section class="section tab-pane" id="tab-alpha-beta">
      <h2>2. Country Level Alpha &amp; Beta</h2>
      <p class="desc">
        각 국가별 벤치마크 대비 연간 알파 및 베타 (OLS, 일 수익률 기준).<br />
        <span style="font-size: 11px; color:#6b7280;">
          Data: <code>alpha_beta_by_country.csv</code>
        </span>
      </p>
      <div class="grid-2">
        <div id="alphaChart" class="chart small"></div>
        <div id="betaChart" class="chart small"></div>
      </div>
    </section>

    <!-- TAB 3: Sector PnL -->
    <section class="section tab-pane" id="tab-sector-pnl">
      <h2>3. Sector Contribution (KRW 기준)</h2>
      <p class="desc">
        전체 기간 섹터별 총 PnL과, PnL 절대값 상위 섹터들의 누적 PnL 타임라인.<br />
        <span style="font-size: 11px; color:#6b7280;">
          Data: <code>sector_contribution_total_KRW.csv</code>, <code>sector_contribution_daily_KRW.csv</code>
        </span>
      </p>
      <div class="grid-2">
        <div id="sectorTotalChart" class="chart small"></div>
        <div id="sectorCumChart" class="chart small"></div>
      </div>
      <div class="footer-note">
        ※ 누적 PnL 그래프는 PnL 절대값 상위 섹터 Top 6 기준입니다.
      </div>
    </section>

    <!-- TAB 4: NAV View -->
    <section class="section tab-pane" id="tab-nav">
      <h2>4. NAV View (By Country &amp; Sector)</h2>
      <p class="desc">
        현재 포트폴리오 NAV를 국가별 Gross / Net 익스포저와, 국가별 섹터 비중, 종목 기여도, 상관관계로 시각화.<br/>
        <span style="font-size: 11px; color:#6b7280;">
          Data: <code>nav_region_breakdown.csv</code>, <code>nav_contribution_by_stock.csv</code>, <code>nav_sector_performance.csv</code>,<br/>
          <code>nav_correlation_matrix.csv</code>, <code>nav_high_corr_pairs.csv</code>
        </span>
      </p>
      <!-- 4-1. Region P&L & Exposure -->
      <div class="grid-2" style="margin-bottom:18px;">
        <div id="navRegionExposureChart" class="chart small"></div>
        <div id="navRegionReturnChart" class="chart small"></div>
      </div>

      <!-- 4-2. Stock Contribution (Top Winners / Losers) -->
      <div class="grid-2" style="margin-bottom:18px;">
        <div id="navTopWinnersChart" class="chart small"></div>
        <div id="navTopLosersChart" class="chart small"></div>
      </div>

      <!-- 4-3. Sector Performance -->
      <div class="grid-2" style="margin-bottom:18px;">
        <div id="navSectorAlphaChart" class="chart small"></div>
        <div id="navSectorPnlChart" class="chart small"></div>
      </div>

      <!-- 4-4. Correlation -->
      <div class="grid-2">
        <div id="navCorrHeatmap" class="chart small"></div>
        <div id="navHighCorrPairs" class="chart small"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== CSV 파서 & 유틸 =====
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(",");
      const rows = lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};
        header.forEach((h, i) => {
          obj[h.trim()] = cols[i] !== undefined ? cols[i].trim() : "";
        });
        return obj;
      });
      return { header, rows };
    }

    async function loadCSV(path) {
      const resp = await fetch(path);
      if (!resp.ok) {
        throw new Error("Failed to load " + path + " : " + resp.status);
      }
      const text = await resp.text();
      return parseCSV(text);
    }

    function toNumber(v) {
      if (v === undefined || v === null || v === "" || isNaN(Number(v))) return null;
      return Number(v);
    }

    // ===== TAB 스위칭 =====
    (function setupTabs() {
      const buttons = Array.from(document.querySelectorAll(".tab-btn"));
      const panes = Array.from(document.querySelectorAll(".tab-pane"));

      function activateTab(id) {
        panes.forEach(p => p.classList.toggle("active", p.id === id));
        buttons.forEach(b => b.classList.toggle("active", b.dataset.tab === id));
      }

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.tab;
          activateTab(id);
        });
      });
    })();

    // ===== 1) Equity vs Hedge Chart =====
    async function buildEquityHedgeChart() {
      try {
        const { rows } = await loadCSV("portfolio_daily_USD_with_hedge.csv");
        const dates = [];
        const equityCum = [];
        const totalCum = [];

        rows.forEach(r => {
          const d = new Date(r["Date"]);
          if (isNaN(d)) return;
          const e = toNumber(r["Equity_Cum_Return"]);
          const t = toNumber(r["Total_Cum_Return"]);
          dates.push(d);
          equityCum.push(e !== null ? e * 100 : null);
          totalCum.push(t !== null ? t * 100 : null);
        });

        const traceEquity = {
          x: dates,
          y: equityCum,
          mode: "lines",
          name: "Equity Only",
          line: { width: 2, color: "#2563eb" }
        };
        const traceTotal = {
          x: dates,
          y: totalCum,
          mode: "lines",
          name: "Equity + Hedge",
          line: { width: 2, color: "#db2777", dash: "dash" }
        };

        const layout = {
          margin: { t: 30, r: 10, b: 40, l: 60 },
          yaxis: { title: "Cumulative Return (%)", zeroline: true },
          xaxis: { title: "Date" },
          legend: { orientation: "h", x: 0, y: 1.1 },
          hovermode: "x unified"
        };

        Plotly.newPlot("equityHedgeChart", [traceEquity, traceTotal], layout, {responsive:true});
      } catch (e) {
        console.error(e);
        const el = document.getElementById("equityHedgeChart");
        el.innerHTML = "<p style='color:#b91c1c;font-size:12px;'>Failed to load portfolio_daily_USD_with_hedge.csv<br/>" + e.message + "</p>";
      }
    }

    // ===== 2) Alpha / Beta Charts =====
    async function buildAlphaBetaCharts() {
      try {
        const { header, rows } = await loadCSV("alpha_beta_by_country.csv");

        const countryCol = header[0];
        const alphaCol = header.find(h => h.includes("alpha_ann")) || "alpha_ann";
        const betaCol  = header.find(h => h === "beta") || "beta";

        const countries = [];
        const alphaVals = [];
        const betaVals  = [];

        rows.forEach(r => {
          const c = r[countryCol];
          if (!c) return;
          const a = toNumber(r[alphaCol]);
          const b = toNumber(r[betaCol]);
          countries.push(c);
          alphaVals.push(a !== null ? a * 100 : null);
          betaVals.push(b);
        });

        const traceAlpha = {
          x: countries,
          y: alphaVals,
          type: "bar",
          marker: { color: "#10b981" },
          name: "Annual Alpha (%)"
        };
        const layoutAlpha = {
          margin: { t: 30, r: 10, b: 50, l: 60 },
          yaxis: { title: "Alpha (%)", zeroline: true },
          xaxis: { title: "Country" },
          hovermode: "closest"
        };
        Plotly.newPlot("alphaChart", [traceAlpha], layoutAlpha, {responsive:true});

        const traceBeta = {
          x: countries,
          y: betaVals,
          type: "bar",
          marker: { color: "#6366f1" },
          name: "Beta"
        };
        const layoutBeta = {
          margin: { t: 30, r: 10, b: 50, l: 60 },
          yaxis: { title: "Beta", zeroline: true },
          xaxis: { title: "Country" },
          shapes: [
            {
              type: "line",
              x0: -0.5,
              x1: countries.length - 0.5,
              y0: 1.0,
              y1: 1.0,
              line: { color: "#9ca3af", width: 1, dash: "dash" }
            }
          ],
          hovermode: "closest"
        };
        Plotly.newPlot("betaChart", [traceBeta], layoutBeta, {responsive:true});

      } catch (e) {
        console.error(e);
        document.getElementById("alphaChart").innerHTML =
          "<p style='color:#b91c1c;font-size:12px;'>Failed to load alpha_beta_by_country.csv<br/>" + e.message + "</p>";
        document.getElementById("betaChart").innerHTML = "";
      }
    }

    // ===== 3) Sector PnL Charts =====
    async function buildSectorCharts() {
      try {
        const totalCSV = await loadCSV("sector_contribution_total_KRW.csv");
        const dailyCSV = await loadCSV("sector_contribution_daily_KRW.csv");

        const sectors = [];
        const pnls = [];

        totalCSV.rows.forEach(r => {
          const s = r["sector"];
          if (!s) return;
          sectors.push(s);
          pnls.push(toNumber(r["Daily_PnL_KRW"]));
        });

        const zipped = sectors.map((s, i) => ({ sector: s, pnl: pnls[i] }));
        zipped.sort((a, b) => a.pnl - b.pnl);

        const sortedSectors = zipped.map(z => z.sector);
        const sortedPnls    = zipped.map(z => z.pnl);

        const traceTotal = {
          x: sortedPnls,
          y: sortedSectors,
          type: "bar",
          orientation: "h",
          marker: { color: "#0ea5e9" },
          name: "Total PnL (KRW)"
        };
        const layoutTotal = {
          margin: { t: 30, r: 20, b: 40, l: 120 },
          xaxis: { title: "Total PnL (KRW)" },
          yaxis: { title: "Sector" },
          hovermode: "closest"
        };
        Plotly.newPlot("sectorTotalChart", [traceTotal], layoutTotal, {responsive:true});

        const absRank = zipped
          .map(z => ({ sector: z.sector, abs: Math.abs(z.pnl) }))
          .sort((a, b) => b.abs - a.abs);
        const topN = 6;
        const topSectors = absRank.slice(0, topN).map(z => z.sector);

        const dailyRaw = dailyCSV.rows.map(r => ({
          date: new Date(r["Date"]),
          sector: r["sector"],
          pnl: toNumber(r["Daily_PnL_KRW"])
        })).filter(d => !isNaN(d.date));

        const sectorSeries = {};
        topSectors.forEach(s => sectorSeries[s] = { x: [], y: [] });

        dailyRaw.sort((a, b) => a.date - b.date);

        const cumMap = {};
        dailyRaw.forEach(d => {
          if (!topSectors.includes(d.sector)) return;
          const key = d.sector;
          if (!(key in cumMap)) cumMap[key] = 0;
          cumMap[key] += (d.pnl || 0);
          sectorSeries[key].x.push(d.date);
          sectorSeries[key].y.push(cumMap[key]);
        });

        const traces = [];
        const palette = ["#1d4ed8", "#b91c1c", "#059669", "#a855f7", "#0f766e", "#f97316"];

        topSectors.forEach((s, idx) => {
          const series = sectorSeries[s];
          if (!series.x.length) return;
          traces.push({
            x: series.x,
            y: series.y,
            mode: "lines",
            name: s,
            line: { width: 2, color: palette[idx % palette.length] }
          });
        });

        const layoutCum = {
          margin: { t: 30, r: 20, b: 40, l: 80 },
          xaxis: { title: "Date" },
          yaxis: { title: "Cumulative PnL (KRW)" },
          hovermode: "x unified",
          legend: { orientation: "v", x: 1.02, y: 1 }
        };
        Plotly.newPlot("sectorCumChart", traces, layoutCum, {responsive:true});

      } catch (e) {
        console.error(e);
        document.getElementById("sectorTotalChart").innerHTML =
          "<p style='color:#b91c1c;font-size:12px;'>Failed to load sector contribution CSVs<br/>" + e.message + "</p>";
        document.getElementById("sectorCumChart").innerHTML = "";
      }
    }

    // ===== 4) NAV Charts =====
    async function buildNavCharts() {
      try {
        // 1) Region breakdown
        const regionCSV = await loadCSV("nav_region_breakdown.csv");
        const regions = [];
        const pnl = [];
        const netExp = [];
        const retPct = [];

        regionCSV.rows.forEach(r => {
          regions.push(r["region"]);
          pnl.push(toNumber(r["pnl_report"]) || 0);
          netExp.push(toNumber(r["net_exposure_report"]) || 0);
          retPct.push((toNumber(r["return_report"]) || 0) * 100);
        });

        // 1-A) Region P&L vs Net Exposure (bar)
        const tracePnl = {
          x: regions,
          y: pnl,
          type: "bar",
          name: "P&L",
          marker: { color: "#2563eb" }
        };
        const traceNet = {
          x: regions,
          y: netExp,
          type: "bar",
          name: "Net Exposure",
          marker: { color: "#f97316" }
        };
        const layoutRegion = {
          barmode: "group",
          margin: { t: 30, r: 20, b: 60, l: 80 },
          xaxis: { title: "Region" },
          yaxis: { title: "Amount (KRW)" },
          hovermode: "closest",
          title: { text: "Region P&L / Net Exposure", font: { size: 14 } }
        };
        Plotly.newPlot("navRegionExposureChart", [tracePnl, traceNet], layoutRegion, {responsive:true});

        // 1-B) Region Return (%)
        const traceRet = {
          x: regions,
          y: retPct,
          type: "bar",
          name: "Return (%)",
          marker: { color: "#059669" }
        };
        const layoutRet = {
          margin: { t: 30, r: 20, b: 60, l: 80 },
          xaxis: { title: "Region" },
          yaxis: { title: "Return (%)" },
          hovermode: "closest",
          title: { text: "Region Returns", font: { size: 14 } }
        };
        Plotly.newPlot("navRegionReturnChart", [traceRet], layoutRet, {responsive:true});

        // 2) Stock contribution (Top Winners / Losers)
        const contribCSV = await loadCSV("nav_contribution_by_stock.csv");
        const sorted = contribCSV.rows
          .map(r => ({
            ticker: r["ticker"],
            region: r["region"],
            type: r["type"],
            pnl: toNumber(r["pnl_report"]) || 0,
            bps: toNumber(r["contribution_bps"]) || 0
          }))
          .sort((a, b) => b.pnl - a.pnl);

        const topN = 10;
        const winners = sorted.slice(0, topN);
        const losers = sorted.slice(-topN).reverse();

        function buildBarData(items) {
          return {
            x: items.map(x => `${x.ticker} (${x.region})`),
            y: items.map(x => x.pnl),
            text: items.map(x => `${x.bps.toFixed(1)} bps`),
            type: "bar"
          };
        }

        const layoutW = {
          margin: { t: 30, r: 20, b: 120, l: 80 },
          xaxis: { title: "Ticker (Region)", tickangle: -45 },
          yaxis: { title: "P&L (KRW)" },
          hovermode: "closest",
          title: { text: "Top Winners (P&L)", font: { size: 14 } }
        };
        const layoutL = {
          margin: { t: 30, r: 20, b: 120, l: 80 },
          xaxis: { title: "Ticker (Region)", tickangle: -45 },
          yaxis: { title: "P&L (KRW)" },
          hovermode: "closest",
          title: { text: "Top Losers (P&L)", font: { size: 14 } }
        };

        Plotly.newPlot("navTopWinnersChart", [buildBarData(winners)], layoutW, {responsive:true});
        Plotly.newPlot("navTopLosersChart", [buildBarData(losers)], layoutL, {responsive:true});

        // 3) Sector performance (P&L / Alpha)
        const sectorCSV = await loadCSV("nav_sector_performance.csv");
        const secNames = [];
        const secPnl = [];
        const secAlpha = [];

        sectorCSV.rows.forEach(r => {
          if (r["Position_Type"] === "Total") return;
          secNames.push(r["sector"]);
          secPnl.push(toNumber(r["P&L"]) || 0);
          secAlpha.push(toNumber(r["Alpha_%"]) || 0);
        });

        const traceAlpha = {
          x: secNames,
          y: secAlpha,
          type: "bar",
          marker: { color: "#a855f7" },
          name: "Alpha (%)"
        };
        const layoutAlpha = {
          margin: { t: 30, r: 20, b: 80, l: 80 },
          xaxis: { title: "Sector", tickangle: -35 },
          yaxis: { title: "Alpha (%)" },
          hovermode: "closest",
          title: { text: "Sector Alpha vs Bench", font: { size: 14 } }
        };
        Plotly.newPlot("navSectorAlphaChart", [traceAlpha], layoutAlpha, {responsive:true});

        const tracePnlSec = {
          x: secNames,
          y: secPnl,
          type: "bar",
          marker: { color: "#0ea5e9" },
          name: "P&L"
        };
        const layoutPnlSec = {
          margin: { t: 30, r: 20, b: 80, l: 80 },
          xaxis: { title: "Sector", tickangle: -35 },
          yaxis: { title: "P&L (KRW)" },
          hovermode: "closest",
          title: { text: "Sector P&L", font: { size: 14 } }
        };
        Plotly.newPlot("navSectorPnlChart", [tracePnlSec], layoutPnlSec, {responsive:true});

        // 4) Correlation heatmap & high corr pairs
        const corrCSV = await loadCSV("nav_correlation_matrix.csv");
        const corrHeader = corrCSV.header;
        const tickers = corrHeader.slice(1);

        const matrix = corrCSV.rows.map(row => {
          return tickers.map(t => toNumber(row[t]) || 0);
        });

        const heatData = [{
          z: matrix,
          x: tickers,
          y: tickers,
          type: "heatmap",
          colorscale: "RdBu",
          zmin: -1,
          zmax: 1
        }];
        const heatLayout = {
          margin: { t: 30, r: 80, b: 80, l: 80 },
          xaxis: { title: "Ticker", tickangle: -45 },
          yaxis: { title: "Ticker" },
          title: { text: "Top Positions Correlation (60d)", font: { size: 14 } }
        };
        Plotly.newPlot("navCorrHeatmap", heatData, heatLayout, {responsive:true});

        const highCorrCSV = await loadCSV("nav_high_corr_pairs.csv");
        const pairs = highCorrCSV.rows
          .map(r => ({
            t1: r["ticker1"],
            type1: r["type1"],
            t2: r["ticker2"],
            type2: r["type2"],
            corr: toNumber(r["corr"]) || 0
          }))
          .sort((a, b) => Math.abs(b.corr) - Math.abs(a.corr));

        const container = document.getElementById("navHighCorrPairs");
        if (pairs.length === 0) {
          container.innerHTML = "<p style='font-size:12px;color:#6b7280;'>No highly correlated pairs (|corr| > 0.6)</p>";
        } else {
          const ul = document.createElement("ul");
          ul.style.fontSize = "12px";
          ul.style.listStyle = "none";
          ul.style.paddingLeft = "0";
          pairs.slice(0, 12).forEach(p => {
            const li = document.createElement("li");
            const rel = (p.type1 !== p.type2) ? "Hedging" : "Same direction";
            li.textContent = `${p.t1} (${p.type1}) vs ${p.t2} (${p.type2}): ${p.corr.toFixed(2)} [${rel}]`;
            ul.appendChild(li);
          });
          container.innerHTML = "<strong style='font-size:13px;'>High Corr Pairs (Top 12)</strong>";
          container.appendChild(ul);
        }
      } catch (e) {
        console.error(e);
        document.getElementById("navRegionExposureChart").innerHTML =
          "<p style='color:#b91c1c;font-size:12px;'>Failed to load NAV CSVs<br/>" + e.message + "</p>";
      }
    }

    // ===== 초기 실행 =====
    (function init() {
      buildEquityHedgeChart();
      buildAlphaBetaCharts();
      buildSectorCharts();
      buildNavCharts();
    })();
  </script>
</body>
</html>
